<view class="page search-page">
  <view class="search-header">
    <text class="search-title">音乐搜索</text>
  </view>

  <view class="search-form">
    <view class="input-group">
      <input
        class="search-input"
        value="{{searchQuery}}"
        type="text"
        placeholder="请输入歌曲名称"
        confirm-type="search"
        bindinput="onQueryChange"
        bindconfirm="handleSearch"
        maxlength="60"
      />
      <button
        class="search-btn"
        bindtap="handleSearch"
        disabled="{{!canSearch || loading}}"
      >
        <text wx:if="{{loading}}">搜索中...</text>
        <text wx:else>搜索</text>
      </button>
    </view>

    <view class="platform-selector">
      <text class="platform-label">音乐平台：</text>
      <radio-group class="platform-options" bindchange="onPlatformChange">
        <label class="platform-option">
          <radio value="1" checked="{{selectedPlatform === 1}}" />
          <text>QQ音乐</text>
        </label>
        <label class="platform-option">
          <radio value="0" checked="{{selectedPlatform === 0}}" />
          <text>网易云音乐</text>
        </label>
      </radio-group>
    </view>
  </view>

  <view wx:if="{{searchResults.length > 0 || loading}}" class="search-results">
    <view class="results-header">
      <text class="results-title">搜索结果</text>
      <text wx:if="{{!loading}}" class="results-count">共 {{searchResults.length}} 首歌曲</text>
    </view>

    <view wx:if="{{loading}}" class="loading-state">
      <view class="loading-spinner"></view>
      <text>正在搜索歌曲...</text>
    </view>

    <scroll-view wx:else scroll-y class="results-list">
      <block wx:for="{{searchResults}}" wx:key="id" wx:for-index="index">
        <view class="song-item" data-index="{{index}}" bindtap="selectSong">
          <view class="song-info">
            <view class="song-title-row">
              <text class="song-title">{{item.name}}</text>
              <text wx:if="{{item.platform_name}}" class="song-platform">{{item.platform_name}}</text>
            </view>
            <text class="song-artist">{{item.artist}}</text>
            <text wx:if="{{item.album}}" class="song-album">{{item.album}}</text>
          </view>
          <view class="song-actions">
            <button
              class="collection-btn"
              data-index="{{index}}"
              catchtap="addToCollection"
            >
              添加到合集
            </button>
            <button
              class="play-btn"
              data-index="{{index}}"
              catchtap="viewLyrics"
            >
              <text>▶</text>
            </button>
          </view>
        </view>
      </block>
    </scroll-view>
  </view>

  <view wx:elif="{{hasSearched && !loading}}" class="empty-state">
    <text class="empty-icon">🎵</text>
    <text>未找到相关歌曲</text>
    <text class="empty-tip">请尝试其他关键词或切换音乐平台</text>
  </view>

  <view wx:if="{{error}}" class="error-message">
    <text class="error-text">{{error}}</text>
    <button class="clear-error-btn" bindtap="clearError">关闭</button>
  </view>

  <view
    wx:if="{{showCollectionModal}}"
    class="modal-overlay"
    bindtap="closeCollectionModal"
  >
    <view class="modal-wrapper" catchtap="noop">
      <view class="modal-header">
        <text class="modal-title">添加到合集</text>
        <button class="close-btn" bindtap="closeCollectionModal">×</button>
      </view>

      <view class="modal-body">
        <view class="selected-song-info" wx:if="{{selectedSong}}">
          <text class="selected-song-title">{{selectedSong.name || selectedSong.title}}</text>
          <text class="selected-song-artist">{{selectedSong.artist}}</text>
        </view>

        <view wx:if="{{collections.length === 0}}" class="no-collections">
          <text>暂无合集，请先创建一个合集</text>
          <button class="create-collection-btn" bindtap="createNewCollection">
            创建新合集
          </button>
        </view>

        <view wx:else class="collections-list">
          <text class="collections-label">选择合集：</text>
          <block wx:for="{{collections}}" wx:key="id">
            <view
              class="collection-option"
              data-id="{{item.id}}"
              bindtap="addSongToCollection"
            >
              <view class="collection-info">
                <text class="collection-name">{{item.name}}</text>
                <text class="collection-count">{{item.songs.length}} 首歌曲</text>
              </view>
              <text class="collection-arrow">→</text>
            </view>
          </block>

          <button class="create-new-btn" bindtap="createNewCollection">
            + 创建新合集
          </button>
        </view>
      </view>
    </view>
  </view>

  <view
    wx:if="{{showCreateModal}}"
    class="modal-overlay"
    bindtap="closeCreateModal"
  >
    <view class="modal-wrapper" catchtap="noop">
      <view class="modal-header">
        <text class="modal-title">创建新合集</text>
        <button class="close-btn" bindtap="closeCreateModal">×</button>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <label>合集名称：</label>
          <input
            class="form-input"
            value="{{newCollectionName}}"
            placeholder="请输入合集名称"
            bindinput="onCollectionNameChange"
            confirm-type="done"
            bindconfirm="createAndAddToCollection"
          />
        </view>

        <view class="form-group">
          <label>合集描述：</label>
          <textarea
            class="form-textarea"
            value="{{newCollectionDescription}}"
            placeholder="请输入合集描述（可选）"
            bindinput="onCollectionDescriptionChange"
          ></textarea>
        </view>

        <view class="modal-actions">
          <button class="cancel-btn" bindtap="closeCreateModal">取消</button>
          <button
            class="confirm-btn"
            bindtap="createAndAddToCollection"
            disabled="{{!canCreateCollection}}"
          >
            创建并添加
          </button>
        </view>
      </view>
    </view>
  </view>

  <view wx:if="{{showSuccessToast}}" class="toast-overlay">
    <view class="toast-content toast-success">
      <view class="toast-icon">✔</view>
      <view class="toast-message">
        <text class="toast-title">操作成功</text>
        <text class="toast-text">{{successMessage}}</text>
      </view>
    </view>
  </view>

  <view wx:if="{{showErrorToast}}" class="toast-overlay">
    <view class="toast-content toast-error">
      <view class="toast-icon">✖</view>
      <view class="toast-message">
        <text class="toast-title">操作失败</text>
        <text class="toast-text">{{errorMessage}}</text>
      </view>
    </view>
  </view>
</view>
