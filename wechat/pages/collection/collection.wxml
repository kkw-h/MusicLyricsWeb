<view class="collection-page">
  <view class="collection-header">
    <button class="add-btn" bindtap="openCreateModal">
      <view class="add-icon">
        <text>+</text>
      </view>
      <text>æ–°å»ºåˆé›†</text>
    </button>
  </view>

  <view wx:if="{{collections.length === 0}}" class="empty-state">
    <view class="empty-icon">ğŸ“</view>
    <text class="empty-title">æš‚æ— åˆé›†</text>
    <text class="empty-tip">åˆ›å»ºåˆé›†æ¥æ”¶è—ä½ å–œæ¬¢çš„æ­Œæ›²</text>
    <button class="create-first-btn" bindtap="openCreateModal">åˆ›å»ºç¬¬ä¸€ä¸ªåˆé›†</button>
  </view>

  <view wx:else class="collections-list">
    <block wx:for="{{collections}}" wx:key="id" wx:for-index="index">
      <view class="collection-item">
        <view class="collection-header-row" data-index="{{index}}" bindtap="toggleCollection">
          <view class="collection-info">
            <text class="collection-name">{{item.name}}</text>
            <text class="collection-meta">
              {{item.songs.length}} é¦–æ­Œæ›² Â· åˆ›å»ºäº {{item.formattedDate}}
            </text>
          </view>
          <view class="collection-actions">
            <button class="action-btn edit-btn" data-index="{{index}}" catchtap="editCollection">
              <view class="btn-icon">âœï¸</view>
            </button>
            <button class="action-btn share-btn" data-index="{{index}}" catchtap="shareCollection">
              <view class="btn-icon">ğŸ“¤</view>
            </button>
            <button
              class="action-btn cache-btn {{item.caching ? 'caching' : ''}}"
              data-index="{{index}}"
              catchtap="cacheCollectionLyrics"
              disabled="{{item.caching || item.songs.length === 0}}"
            >
              <view wx:if="{{item.caching}}" class="cache-spinner"></view>
              <view wx:else class="btn-icon">ğŸ’¾</view>
            </button>
            <button class="action-btn delete-btn" data-index="{{index}}" catchtap="deleteCollection">
              <view class="btn-icon">ğŸ—‘ï¸</view>
            </button>
            <button
              class="expand-btn {{item.expanded ? 'expanded' : ''}}"
              data-index="{{index}}"
              catchtap="toggleCollection"
            >
              <view class="expand-icon">âŒ„</view>
            </button>
          </view>
        </view>

        <view wx:if="{{item.expanded}}" class="collection-content">
          <view wx:if="{{item.songs.length === 0}}" class="empty-collection">
            <text>è¯¥åˆé›†æš‚æ— æ­Œæ›²</text>
            <button class="add-song-btn" data-index="{{index}}" bindtap="goToSearch">
              æ·»åŠ æ­Œæ›²
            </button>
          </view>

          <view wx:else class="songs-list">
            <block wx:for="{{item.songs}}" wx:key="id" wx:for-index="songIndex">
              <view class="song-item">
                <view class="song-index">{{songIndex + 1}}</view>
                <view class="song-info">
                  <text class="song-title">{{item.title}}</text>
                  <text class="song-artist">{{item.artist}}</text>
                </view>
                <view class="song-actions">
                  <button
                    class="action-btn play-btn"
                    data-song="{{songIndex}}"
                    data-collection="{{index}}"
                    catchtap="viewSongLyrics"
                  >
                    <view class="btn-icon">ğŸµ</view>
                  </button>
                  <button
                    class="action-btn remove-btn"
                    data-song="{{songIndex}}"
                    data-collection="{{index}}"
                    catchtap="removeSong"
                  >
                    <view class="btn-icon">âœ•</view>
                  </button>
                </view>
              </view>
            </block>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- æ–°å»º/ç¼–è¾‘åˆé›†å¼¹çª— -->
  <view wx:if="{{showModal}}" class="modal-overlay" bindtap="closeModal">
    <view class="modal-content" catchtap="noop">
      <text class="modal-title">{{editingCollectionId ? 'ç¼–è¾‘åˆé›†' : 'æ–°å»ºåˆé›†'}}</text>
      <view class="form-group">
        <text class="form-label">åˆé›†åç§°</text>
        <input
          class="form-input"
          value="{{modalForm.name}}"
          placeholder="è¯·è¾“å…¥åˆé›†åç§°"
          bindinput="onModalNameChange"
          confirm-type="done"
          bindconfirm="saveCollection"
        />
      </view>
      <view class="form-group">
        <text class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</text>
        <textarea
          class="form-textarea"
          value="{{modalForm.description}}"
          placeholder="è¯·è¾“å…¥åˆé›†æè¿°"
          bindinput="onModalDescriptionChange"
        ></textarea>
      </view>
      <view class="modal-actions">
        <button class="cancel-btn" bindtap="closeModal">å–æ¶ˆ</button>
        <button
          class="save-btn"
          bindtap="saveCollection"
          disabled="{{!canSaveCollection}}"
        >
          {{editingCollectionId ? 'ä¿å­˜' : 'åˆ›å»º'}}
        </button>
      </view>
    </view>
  </view>

  <!-- åˆ†äº«åˆé›†å¼¹çª— -->
  <view wx:if="{{showShareModal}}" class="modal-overlay" bindtap="closeShareModal">
    <view class="modal-content share-modal" catchtap="noop">
      <view class="share-header">
        <text class="modal-title">åˆ†äº«åˆé›†</text>
        <button class="close-btn" bindtap="closeShareModal">Ã—</button>
      </view>
      <view class="share-content">
        <view class="collection-preview">
          <text class="preview-name">{{selectedCollection.name}}</text>
          <text class="preview-desc">{{selectedCollection.description || 'æš‚æ— æè¿°'}}</text>
          <text class="preview-count">{{selectedCollection.songs.length}} é¦–æ­Œæ›²</text>
        </view>
        <view class="qr-section">
          <view class="qr-container">
            <image
              wx:if="{{qrCodeImage}}"
              src="{{qrCodeImage}}"
              mode="aspectFit"
              class="qr-image"
            />
            <view wx:else class="qr-loading">
              <view class="spinner"></view>
              <text>ç”ŸæˆäºŒç»´ç ä¸­...</text>
            </view>
          </view>
          <text class="qr-tip">
            ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å³å¯å¯¼å…¥æ­¤åˆé›†åˆ°æ‚¨çš„æ­Œå•ä¸­
          </text>
        </view>
        <view class="share-actions">
          <button class="copy-btn" bindtap="copyShareLink">
            å¤åˆ¶é“¾æ¥
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç¼“å­˜è¿›åº¦å¼¹çª— -->
  <view wx:if="{{cacheProgress.show}}" class="cache-progress-overlay">
    <view class="cache-progress-modal">
      <view class="progress-header">
        <text class="modal-title">æ­£åœ¨ç¼“å­˜æ­Œè¯</text>
        <view class="progress-info">
          <text class="collection-name">{{cacheProgress.collectionName}}</text>
          <text class="progress-count">
            {{cacheProgress.current}} / {{cacheProgress.total}}
          </text>
        </view>
      </view>
      
      <view class="progress-content">
        <view class="progress-bar-container">
          <view class="progress-bar">
            <view
              class="progress-fill"
              style="width: {{cacheProgress.percentage}}%;"
            ></view>
          </view>
          <view class="progress-percentage">
            {{Math.round(cacheProgress.percentage)}}%
          </view>
        </view>
        
        <view wx:if="{{cacheProgress.currentSong}}" class="current-song">
          <view class="song-icon">ğŸµ</view>
          <view class="song-details">
            <text class="song-title">{{cacheProgress.currentSong.title}}</text>
            <text class="song-artist">{{cacheProgress.currentSong.artist}}</text>
          </view>
        </view>
      </view>
      
      <view class="progress-tip">
        <text>æ­£åœ¨ä¸ºæ‚¨ç¼“å­˜æ­Œè¯ï¼Œè¯·ç¨å€™...</text>
        <text class="tip-note">ç¼“å­˜å®Œæˆåå¯ç¦»çº¿æŸ¥çœ‹æ­Œè¯</text>
      </view>
    </view>
  </view>
</view>
